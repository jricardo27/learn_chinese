<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandarin Learner (Vue)</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="custom-select.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak class="app-container">
        <!-- Persistent Header -->
        <header class="sticky-header">
            <div class="header-top">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button @click="setMode('home')" class="home-btn" title="Go to Home Screen"
                        v-show="currentMode !== 'home'">
                        <i class="fas fa-home"></i>
                    </button>
                    <h1><i class="fas fa-book-open"></i> Mandarin Learner</h1>
                    <!-- Mobile Menu Toggle (Moved here) -->
                    <button class="mobile-menu-btn" @click="mobileMenuOpen = !mobileMenuOpen"
                        style="margin-left: auto;">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>

                <div class="global-controls">




                    <!-- Collapsible Controls Component -->
                    <mobile-menu :is-open="mobileMenuOpen" :volume="volume" :mode="currentMode"
                        :count="filteredWords.length" @update:volume="volume = $event"
                        @update:mode="currentMode = $event; $nextTick(() => onModeChange())">
                    </mobile-menu>
                </div>
            </div>
        </header>



        <div v-show="isQuizLikeMode" class="quiz-score"
            style="position: absolute; top: 100px; right: 20px; z-index: 1001; background: rgba(0,0,0,0.6); color: white; padding: 5px 15px; border-radius: 20px;">
            <span class="score-correct">✅ {{ quizScore.correct }}</span>
            <span class="score-wrong">❌ {{ quizScore.wrong }}</span>
        </div>



        <main>
            <!-- Home Screen -->
            <div v-if="currentMode === 'home'" class="home-screen">
                <h1 class="home-title">Mandarin Mastery</h1>
                <p class="home-subtitle">Choose a mode to begin your journey</p>

                <div class="mode-cards-grid">
                    <div v-for="mode in modes" :key="mode.id" class="mode-card" @click="setMode(mode.id)">
                        <div :class="['mode-icon', mode.iconClass]">
                            <i :class="mode.icon"></i>
                        </div>
                        <h3>{{ mode.title }}</h3>
                        <p>{{ mode.desc }}</p>
                    </div>
                </div>
            </div>

            <!-- Mode Welcome Screen with Settings -->
            <div v-else-if="currentWordIndex === -1 && !searchQuery" class="welcome-screen-container">
                <div class="welcome-screen">
                    <div class="welcome-icon-circle">
                        <i :class="['fas', currentModeConfig.icon]"></i>
                    </div>
                    <h2>{{ currentModeConfig.title }}</h2>
                    <p>{{ currentModeConfig.desc }}</p>

                    <div class="mode-settings">
                        <label class="setting-row" v-if="currentMode !== 'recall'">
                            <input type="checkbox" v-model="autoContinue"
                                :disabled="currentMode === 'shadowing' && compareEnabled">
                            <span>Auto-continue to next word</span>
                        </label>
                        <label class="setting-row">
                            <input type="checkbox" v-model="isShuffled">
                            <span>Shuffle words for this session</span>
                        </label>
                        <label v-if="currentMode === 'shadowing'" class="setting-row">
                            <input type="checkbox" v-model="autoRecord">
                            <span>Auto-record after audio</span>
                        </label>
                        <label v-if="currentMode === 'shadowing'" class="setting-row">
                            <input type="checkbox" v-model="compareEnabled" @change="onCompareToggle">
                            <span>Compare Pronunciation (Manual review)</span>
                        </label>
                        <div v-if="currentMode === 'writing'" class="setting-row"
                            style="justify-content: space-between;">
                            <span>Target:</span>
                            <select v-model="writingTarget" style="padding: 5px; border-radius: 5px;">
                                <option value="hanzi">Write Hanzi</option>
                                <option value="pinyin">Write Pinyin</option>
                            </select>
                        </div>
                        <div v-if="currentMode === 'tonePractice'" class="setting-row"
                            style="flex-direction: column; align-items: flex-start;">
                            <span style="margin-bottom: 8px;">Select Tone to Practice:</span>
                            <div class="tone-selector-group">
                                <button v-for="t in [1,2,3,4]" :key="t" @click="selectedTone = t"
                                    :class="['tone-btn', { active: selectedTone === t }]">
                                    Tone {{ t }}
                                </button>
                            </div>
                        </div>
                    </div>

                    <button @click="startSession" class="start-session-btn">
                        <i class="fas fa-play" style="margin-right: 12px;"></i> Start Session
                    </button>
                    <button @click="currentWordIndex = -2" class="browse-grid-btn">Or browse word list first</button>
                </div>
            </div>

            <!-- Word Grid -->
            <div v-else class="word-container">
                <div v-for="word in filteredWords" :key="word.id"
                    :class="['word-card', { playing: activeWordId === word.id, revealed: recallRevealedId === word.id && currentMode === 'recall' }]"
                    @click="onCardClick(word)">
                    <div class="word-number">#{{ word.number }}</div>
                    <img :src="word.image" alt="Word Image" class="word-image">
                    <div class="word-info">
                        <h3 :class="{ 'blur-text': currentMode === 'recall' && hideChinese }">{{ word.chinese }}</h3>
                        <p :class="['pinyin', { 'blur-text': currentMode === 'recall' && hidePinyin }]">{{ word.pinyin
                            }}</p>
                        <p class="english">{{ word.english }}</p>
                        <div class="categories" style="margin-top: 8px;">
                            <span v-for="cat in word.categories" :key="cat" class="category-badge">{{ cat }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Spoken Text Toast (Visual Feedback for TTS) -->
            <transition name="fade">
                <div v-if="spokenText" class="toast-notification">
                    <i class="fas fa-volume-up"></i> {{ spokenText }}
                </div>
            </transition>

            <!-- Overlays -->
            <div v-if="overlayWord" class="quiz-overlay">

                <!-- Standard Overlay -->
                <!-- Standard Overlay -->
                <div v-if="currentMode === 'standard'" class="base-card standard-card">
                    <h2 class="mode-title">{{ currentModeTitle }}</h2>
                    <img :src="overlayWord.image" alt="Word Image" class="quiz-image">
                    <div class="recall-info-container">
                        <div class="recall-text">{{ overlayWord.chinese }}</div>
                        <div class="recall-text" style="font-size: 1.5em; color: #666;">{{ overlayWord.pinyin }}</div>
                        <div class="recall-text" style="font-size: 1.2em; color: #888;">{{ overlayWord.english }}</div>
                    </div>
                    <div class="standard-controls">
                        <button @click="togglePlayPause" :class="isPlaying ? 'pause-btn' : 'replay-btn'">
                            <i :class="isPlaying ? 'fas fa-pause' : 'fas fa-play'"></i>
                            {{ isPlaying ? 'Pause' : 'Play Audio' }}
                        </button>
                        <div class="nav-btn-group">
                            <button @click="playPrev" class="quiz-btn" :disabled="currentWordIndex === 0"><i
                                    class="fas fa-arrow-left"></i> Prev</button>
                            <button @click="playNext" class="quiz-btn"><i class="fas fa-arrow-right"></i> Next</button>
                        </div>
                        <button @click="stopPlayback" class="finish-quiz-btn"><i class="fas fa-times-circle"></i> Finish
                            View</button>
                    </div>
                </div>

                <!-- Recall Overlay -->
                <!-- Recall Overlay -->
                <div v-if="currentMode === 'recall'"
                    :class="['base-card', 'recall-card-base', 'recall-card', { revealed: isRecallRevealed }]">
                    <h2 class="mode-title">{{ currentModeTitle }}</h2>
                    <img :src="overlayWord.image" alt="Word Image" class="quiz-image">
                    <div class="recall-info-container">
                        <div :class="['recall-text', { 'blur-text': hideChinese && !isRecallRevealed }]">{{
                            overlayWord.chinese }}</div>
                        <div :class="['recall-text', { 'blur-text': hidePinyin && !isRecallRevealed }]">{{
                            overlayWord.pinyin }}</div>
                        <div :class="['recall-text', { 'blur-text': hideChinese && !isRecallRevealed }]"
                            style="font-size: 1.2em; color: #666;">{{ overlayWord.english }}</div>
                    </div>
                    <div class="recall-controls">
                        <button @click="revealRecall" class="replay-btn"><i class="fas fa-eye"></i> {{ isRecallRevealed
                            ? 'Replay' : 'Reveal' }}</button>
                        <div class="nav-btn-group">
                            <button @click="playPrev" class="quiz-btn" :disabled="currentWordIndex === 0"><i
                                    class="fas fa-arrow-left"></i> Prev</button>
                            <button @click="playNext" class="quiz-btn"><i class="fas fa-arrow-right"></i> Next</button>
                        </div>
                        <button @click="stopPlayback" class="finish-quiz-btn"><i class="fas fa-times-circle"></i> Finish
                            Practice</button>
                    </div>
                </div>

                <!-- Shadowing Overlay -->
                <div v-if="currentMode === 'shadowing'" class="base-card shadow-card shadowing-card">
                    <h2 class="mode-title">{{ currentModeTitle }}</h2>
                    <div class="shadowing-layout-container">
                        <div class="shadowing-left">
                            <img :src="overlayWord.image" alt="Word Image" class="quiz-image shadow-main-img">

                            <div :class="['shadowing-status', shadowingStatusClass]"
                                style="position: relative; overflow: hidden;">
                                <div v-if="shadowingState === 'recording'" class="recording-progress-bar"
                                    :style="{ width: recordingProgress + '%' }"></div>
                                <i :class="shadowingStatusIcon" style="position: relative; z-index: 1;"></i>
                                <span style="position: relative; z-index: 1;">{{ shadowingStatusText }}</span>
                            </div>
                        </div>

                        <div class="shadowing-right">
                            <div class="shadowing-info-container">
                                <div class="shadowing-text">{{ overlayWord.chinese }}</div>
                                <div class="shadowing-text-pinyin">{{ overlayWord.pinyin }}</div>
                                <div class="shadowing-text-english">{{ overlayWord.english }}</div>
                            </div>

                            <!-- Tone Comparison Results -->
                            <div v-if="comparisonResults.overallScore" class="comparison-results">
                                <div class="score-circle" :style="scoreStyle">
                                    {{ comparisonResults.overallScore }}%
                                </div>
                                <div class="feedback-text">{{ comparisonResults.feedback }}</div>
                            </div>

                            <div v-if="compareEnabled && shadowingState === 'idle'" class="retry-options"
                                style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
                                <button @click="playActiveWord(true)" class="retry-btn">
                                    <i class="fas fa-redo"></i> Listen & Record
                                </button>
                                <button @click="retryRecordingOnly" class="retry-btn"
                                    style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);">
                                    <i class="fas fa-microphone"></i> Record Only
                                </button>
                            </div>

                            <div class="tone-comparison-container"
                                v-show="shadowingState === 'playback' || shadowingState === 'idle'">
                                <canvas id="toneCanvas" width="450" height="180" @click="replayAudio"></canvas>
                                <div class="tone-legend">
                                    <span class="legend-reference">Reference</span>
                                    <span class="legend-user">You</span>
                                </div>
                            </div>

                            <div class="shadowing-controls">
                                <button v-show="shadowingState !== 'recording' && !compareEnabled"
                                    @click="handleShadowingMainAction" :class="isLooping ? 'pause-btn' : 'replay-btn'">
                                    <i :class="shadowingMainActionIcon"></i>
                                    {{ shadowingMainActionText }}
                                </button>
                                <button v-if="shadowingState === 'recording'" @click="stopManualRecording"
                                    class="pause-btn"><i class="fas fa-pause"></i> Pause Recording</button>
                                <button v-if="!autoRecord && shadowingState === 'idle'" @click="startManualRecording"
                                    class="record-btn"><i class="fas fa-microphone"></i> Record</button>

                                <div class="nav-btn-group">
                                    <button @click="playPrev" class="quiz-btn" :disabled="currentWordIndex === 0"><i
                                            class="fas fa-arrow-left"></i>
                                        Prev</button>
                                    <button @click="playNext" class="quiz-btn"><i class="fas fa-arrow-right"></i>
                                        Next</button>
                                </div>
                                <button @click="stopPlayback" class="finish-quiz-btn"><i
                                        class="fas fa-times-circle"></i>
                                    Finish
                                    Practice</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tone Practice Overlay (similar to Standard but with length focus) -->
                <div v-if="currentMode === 'tonePractice'" class="base-card tone-card">
                    <h2 class="mode-title">{{ currentModeTitle }}</h2>
                    <img :src="overlayWord.image" alt="Word Image" class="quiz-image">
                    <div class="recall-info-container">
                        <div class="recall-text">{{ overlayWord.chinese }}</div>
                        <div class="recall-text" style="font-size: 1.5em; color: #666;">{{ overlayWord.pinyin }}</div>
                        <div class="recall-text" style="font-size: 1.2em; color: #888;">{{ overlayWord.english }}</div>
                    </div>
                    <div class="standard-controls">
                        <button @click="togglePlayPause" :class="isPlaying ? 'pause-btn' : 'replay-btn'">
                            <i :class="isPlaying ? 'fas fa-pause' : 'fas fa-play'"></i>
                            {{ isPlaying ? 'Pause' : 'Play Audio' }}
                        </button>
                        <div class="nav-btn-group">
                            <button @click="playPrev" class="quiz-btn" :disabled="currentWordIndex === 0"><i
                                    class="fas fa-arrow-left"></i> Prev</button>
                            <button @click="playNext" class="quiz-btn"><i class="fas fa-arrow-right"></i> Next</button>
                        </div>
                        <button @click="stopPlayback" class="finish-quiz-btn"><i class="fas fa-times-circle"></i> Finish
                            Practice</button>
                    </div>
                </div>

                <!-- Multiple Choice (Quiz, Animal Match, Category Match) -->
                <div v-if="isQuizLikeMode" class="base-card quiz-game-card">
                    <h2 class="mode-title">{{ currentModeTitle }}</h2>
                    <div class="quiz-header">
                        <div class="quiz-score-live">Score: <span class="score-correct">✅ {{ quizScore.correct }}</span>
                            / <span class="score-wrong">❌ {{ quizScore.wrong }}</span></div>
                    </div>

                    <div style="text-align: center; margin-bottom: 20px;">
                        <img :src="overlayWord.image" alt="Word Image" class="quiz-image">
                        <div style="text-align: center; margin-bottom: 10px;">
                            <button @click="replayAudio" class="replay-btn" style="width: auto; padding: 8px 20px;">
                                <i class="fas fa-volume-up"></i> Listen
                            </button>
                            <label style="margin-left: 15px; font-size: 0.9em; user-select: none;">
                                <input type="checkbox" v-model="hidePinyin"> Hide Pinyin
                            </label>
                        </div>
                    </div>

                    <div class="quiz-options-large">
                        <button v-for="choice in quizChoices" :key="choice.id"
                            :class="['quiz-btn', getQuizBtnClass(choice)]" :disabled="quizAnswered"
                            @click="handleQuizAnswer(choice)">
                            {{ getChoiceLabel(choice) }}
                        </button>
                    </div>
                    <button @click="stopPlayback" class="finish-quiz-btn"><i class="fas fa-times-circle"></i> Finish
                        Quiz</button>
                </div>

                <!-- Writing Practice (Merged Pinyin/Hanzi) -->
                <div v-if="currentMode === 'writing'" class="base-card writing-card">
                    <h2 class="mode-title">{{ currentModeTitle }}</h2>
                    <img :src="overlayWord.image" alt="Word Image" class="quiz-image">
                    <div style="text-align: center; margin-bottom: 10px;">
                        <h3 v-if="writingTarget === 'pinyin'" style="font-size: 2em; color: #333;">{{
                            overlayWord.chinese }}</h3>
                        <h3 v-else style="font-size: 1.2em; color: #666; font-style: italic;">{{ overlayWord.english }}
                        </h3>

                        <button @click="replayAudio" class="replay-btn"
                            style="width: auto; margin-top: 10px; padding: 8px 25px;">
                            <i class="fas fa-volume-up"></i> Listen
                        </button>
                    </div>

                    <div class="writing-input-container">
                        <input type="text" v-model="userInput" @keyup.enter="checkWritingAnswer"
                            :class="['writing-input', writingStatus]"
                            :placeholder="writingTarget === 'pinyin' ? 'Type Pinyin' : 'Type Hanzi'" autofocus>
                    </div>

                    <button v-if="!quizAnswered" @click="checkWritingAnswer" class="replay-btn"
                        style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); margin-bottom: 15px;">
                        <i class="fas fa-check-circle"></i> Verify Answer
                    </button>

                    <div v-if="quizAnswered" class="recall-info-container" style="min-height: 60px;">
                        <div class="recall-text"
                            :style="{ color: writingStatus === 'correct' ? '#28a745' : '#dc3545' }">
                            {{ writingStatus === 'correct' ? 'Correct!' : 'Try Again!' }} <br>
                            <span style="font-size: 0.6em; color: #555;">Correct answer: {{ writingTarget === 'pinyin' ?
                                overlayWord.pinyin : overlayWord.chinese }}</span>
                        </div>
                    </div>

                    <div class="nav-btn-group">
                        <button @click="playPrev" class="quiz-btn" :disabled="currentWordIndex === 0"><i
                                class="fas fa-arrow-left"></i> Prev</button>
                        <button @click="playNext" class="quiz-btn"><i class="fas fa-arrow-right"></i> Next</button>
                    </div>
                    <button @click="stopPlayback" class="finish-quiz-btn"><i class="fas fa-times-circle"></i> Finish
                        Practice</button>
                </div>

                <!-- Classifier Match -->
                <div v-if="currentMode === 'classifierMatch'" class="base-card classifier-card">
                    <h2 class="mode-title">{{ currentModeTitle }}</h2>
                    <div class="classifier-layout-container">
                        <div class="classifier-left">
                            <img :src="overlayWord.image" alt="Word Image" class="quiz-image">
                            <p style="color: #888; font-size: 0.9em; margin-top: 10px; font-style: italic;">Category: {{
                                overlayWord.categories.join(', ') }}</p>
                        </div>

                        <div class="classifier-right">
                            <div style="text-align: center;">
                                <h3 style="font-size: 2em; color: #333; margin-bottom: 5px;">{{ overlayWord.chinese }}
                                </h3>
                                <div
                                    style="height: 1.5em; display: flex; align-items: center; justify-content: center; margin-bottom: 5px;">
                                    <p :style="{ visibility: hidePinyin ? 'hidden' : 'visible' }"
                                        style="font-size: 1.2em; color: #666; margin: 0;">{{ overlayWord.pinyin }}</p>
                                </div>
                                <p style="color: #666; margin-bottom: 10px;">{{ overlayWord.english }}</p>
                                <div style="margin-bottom: 10px;">
                                    <label><input type="checkbox" v-model="hidePinyin"> Hide Pinyin</label>
                                </div>
                            </div>

                            <div class="classifier-bubble">
                                {{ quizAnswered ? (overlayWord.classifier || '无') : '?' }}
                            </div>

                            <div v-if="!autoContinue && quizAnswered" style="text-align: center; margin-top: 5px;">
                                <button @click="repeatClassifierAudio" class="replay-btn"
                                    style="width: auto; padding: 5px 15px; font-size: 0.9em;">
                                    <i class="fas fa-volume-up"></i> Listen Again
                                </button>
                            </div>

                            <div class="quiz-options-large" style="margin-top: 15px;">
                                <button v-for="choice in quizChoices" :key="choice"
                                    :class="['quiz-btn', getClassifierBtnClass(choice)]" :disabled="quizAnswered"
                                    @click="handleClassifierAnswer(choice)"
                                    style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80px;">
                                    <div
                                        :style="{ visibility: hidePinyin ? 'hidden' : 'visible', fontSize: '0.8em', color: '#666', marginBottom: '2px' }">
                                        {{ getClassifierPinyin(choice) }}
                                    </div>
                                    <div style="font-size: 1.4em; font-weight: bold;">{{ choice }}</div>
                                </button>
                            </div>
                            <button @click="stopPlayback" class="finish-quiz-btn" style="margin-top: 15px;"><i
                                    class="fas fa-times-circle"></i> Finish
                                Quiz</button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script src="words_data.js"></script>
    <script src="words_analysis.js"></script>
    <script src="script.js"></script>
</body>

</html>