<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandarin Learner (Vue)</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak class="app-container">
        <!-- Persistent Header -->
        <header class="sticky-header">
            <div class="header-top">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button @click="setMode('home')" class="home-btn" title="Go to Home Screen"
                        v-show="currentMode !== 'home'">
                        <i class="fas fa-home"></i>
                    </button>
                    <h1><i class="fas fa-book-open"></i> Mandarin Learner</h1>
                </div>

                <div class="global-controls">
                    <div class="search-box">
                        <input type="text" v-model="searchQuery" placeholder="Search words..."
                            style="padding: 8px 15px; border-radius: 20px; border: none; font-size: 14px; background: rgba(255,255,255,0.95); color: #333; width: 150px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    </div>

                    <select v-model="currentMode" @change="onModeChange"
                        style="padding: 8px 15px; border-radius: 20px; border: none; font-size: 14px; background: rgba(255,255,255,0.95); color: #333; font-weight: 500; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <optgroup label="Core Modes">
                            <option value="standard">Standard Mode</option>
                            <option value="recall">Recall Mode</option>
                            <option value="shadowing">Shadowing Mode</option>
                            <option value="quiz">Quiz Mode</option>
                        </optgroup>
                        <optgroup label="Learning Games">
                            <option value="writingPinyin">Write Pinyin</option>
                            <option value="writingHanzi">Write Hanzi</option>
                            <option value="classifierMatch">Classifier Match</option>
                            <option value="animalMatch">Animal Number Match</option>
                            <option value="categoryMatch">Category Match</option>
                        </optgroup>
                    </select>

                    <div :class="['order-toggle', { active: !isShuffled }]" @click="toggleOrder"
                        title="Toggle Shuffled/Original Order">
                        <i :class="isShuffled ? 'fas fa-random' : 'fas fa-sort-numeric-down'"></i>
                        <span>{{ isShuffled ? 'Shuffled' : 'Sequential' }}</span>
                    </div>

                    <div class="volume-controls"
                        style="color: #333; background: rgba(255,255,255,0.95); padding: 5px 12px; border-radius: 20px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <i class="fas fa-volume-down" style="font-size: 0.9em; margin-right: 5px;"></i>
                        <input type="range" v-model="volume" min="0" max="100"
                            style="width: 60px; height: 4px; accent-color: #4a00e0;">
                        <i class="fas fa-volume-up" style="font-size: 0.9em; margin-left: 5px;"></i>
                    </div>

                    <span class="word-count-display"
                        style="background: rgba(255,255,255,0.95); color: #333; padding: 5px 12px; border-radius: 20px; font-size: 0.9em; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        Total: <span style="font-weight: bold; color: #4a00e0;">{{ filteredWords.length }}</span>
                    </span>

                    <div v-show="isQuizLikeMode" class="quiz-score" style="background: rgba(0,0,0,0.2);">
                        <span class="score-correct">✅ {{ quizScore.correct }}</span>
                        <span class="score-wrong">❌ {{ quizScore.wrong }}</span>
                    </div>
                </div>
            </div>

            <!-- Global Player Controls -->
            <div class="player-controls">
                <div class="player-info">
                    <h4>{{ statusText }}</h4>
                </div>
                <div class="player-buttons">
                    <button @click="playPrev" title="Previous Word (Arrow Left)"><i
                            class="fas fa-step-backward"></i></button>
                    <button @click="togglePlayPause" title="Play/Pause (Space)"><i
                            :class="isPlaying ? 'fas fa-pause' : 'fas fa-play'"></i></button>
                    <button @click="stopPlayback" title="Stop Playback (Esc)"><i class="fas fa-stop"></i></button>
                    <button @click="playNext" title="Next Word (Arrow Right)"><i
                            class="fas fa-step-forward"></i></button>
                </div>
            </div>
        </header>

        <main>
            <!-- Home Screen -->
            <div v-if="currentMode === 'home'" class="home-screen">
                <div class="home-content">
                    <h2 class="home-title">Mandarin Mastery</h2>
                    <p class="home-subtitle">Choose a mode to begin your journey</p>

                    <div class="mode-cards-grid">
                        <div v-for="mode in modes" :key="mode.id" class="mode-card" @click="setMode(mode.id)">
                            <div :class="['mode-icon', mode.iconClass]"><i :class="mode.icon"></i></div>
                            <h3>{{ mode.title }}</h3>
                            <p>{{ mode.desc }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mode Welcome Screen with Settings -->
            <div v-else-if="currentWordIndex === -1 && !searchQuery" class="welcome-screen-container">
                <div class="welcome-screen">
                    <div class="welcome-icon-circle">
                        <i :class="['fas', currentModeConfig.icon]"></i>
                    </div>
                    <h2>{{ currentModeConfig.title }}</h2>
                    <p>{{ currentModeConfig.desc }}</p>

                    <div class="mode-settings">
                        <label class="setting-row">
                            <input type="checkbox" v-model="autoContinue">
                            <span>Auto-continue to next word</span>
                        </label>
                        <label class="setting-row">
                            <input type="checkbox" v-model="isShuffled">
                            <span>Shuffle words for this session</span>
                        </label>
                        <label v-if="currentMode === 'shadowing'" class="setting-row">
                            <input type="checkbox" v-model="autoRecord">
                            <span>Auto-record after audio</span>
                        </label>
                    </div>

                    <button @click="startSession" class="start-session-btn">
                        <i class="fas fa-play" style="margin-right: 12px;"></i> Start Session
                    </button>
                    <button @click="currentWordIndex = -2" class="browse-grid-btn">Or browse word list first</button>
                </div>
            </div>

            <!-- Word Grid -->
            <div v-else class="word-container">
                <div v-for="word in filteredWords" :key="word.id"
                    :class="['word-card', { playing: activeWordId === word.id, revealed: recallRevealedId === word.id && currentMode === 'recall' }]"
                    @click="onCardClick(word)">
                    <div class="word-number">#{{ word.number }}</div>
                    <img :src="word.image" alt="Word Image" class="word-image">
                    <div class="word-info">
                        <h3 :class="{ 'blur-text': currentMode === 'recall' && hideChinese }">{{ word.chinese }}</h3>
                        <p :class="['pinyin', { 'blur-text': currentMode === 'recall' && hidePinyin }]">{{ word.pinyin
                            }}</p>
                        <p class="english">{{ word.english }}</p>
                        <div class="categories" style="margin-top: 8px;">
                            <span v-for="cat in word.categories" :key="cat" class="category-badge">{{ cat }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overlays -->
            <div v-if="overlayWord" class="quiz-overlay">

                <!-- Standard Overlay -->
                <div v-if="currentMode === 'standard'" class="quiz-card">
                    <img :src="overlayWord.image" alt="Word Image" class="quiz-image">
                    <div class="recall-info-container">
                        <div class="recall-text">{{ overlayWord.chinese }}</div>
                        <div class="recall-text" style="font-size: 1.5em; color: #666;">{{ overlayWord.pinyin }}</div>
                        <div class="recall-text" style="font-size: 1.2em; color: #888;">{{ overlayWord.english }}</div>
                    </div>
                    <div class="standard-controls">
                        <button @click="togglePlayPause" :class="isPlaying ? 'pause-btn' : 'replay-btn'">
                            <i :class="isPlaying ? 'fas fa-pause' : 'fas fa-play'"></i>
                            {{ isPlaying ? 'Pause' : 'Play Audio' }}
                        </button>
                        <div class="nav-btn-group">
                            <button @click="playPrev" class="quiz-btn"><i class="fas fa-arrow-left"></i> Prev</button>
                            <button @click="playNext" class="quiz-btn"><i class="fas fa-arrow-right"></i> Next</button>
                        </div>
                        <button @click="stopPlayback" class="finish-quiz-btn"><i class="fas fa-times-circle"></i> Finish
                            View</button>
                    </div>
                </div>

                <!-- Recall Overlay -->
                <div v-if="currentMode === 'recall'"
                    :class="['quiz-card', 'recall-card', { revealed: isRecallRevealed }]">
                    <img :src="overlayWord.image" alt="Word Image" class="quiz-image">
                    <div class="recall-info-container">
                        <div :class="['recall-text', { 'blur-text': hideChinese && !isRecallRevealed }]">{{
                            overlayWord.chinese }}</div>
                        <div :class="['recall-text', { 'blur-text': hidePinyin && !isRecallRevealed }]">{{
                            overlayWord.pinyin }}</div>
                        <div :class="['recall-text', { 'blur-text': hideChinese && !isRecallRevealed }]"
                            style="font-size: 1.2em; color: #666;">{{ overlayWord.english }}</div>
                    </div>
                    <div class="recall-controls">
                        <button @click="revealRecall" class="replay-btn"><i class="fas fa-eye"></i> {{ isRecallRevealed
                            ? 'Replay' : 'Reveal' }}</button>
                        <div class="nav-btn-group">
                            <button @click="playPrev" class="quiz-btn"><i class="fas fa-arrow-left"></i> Prev</button>
                            <button @click="playNext" class="quiz-btn"><i class="fas fa-arrow-right"></i> Next</button>
                        </div>
                        <button @click="stopPlayback" class="finish-quiz-btn"><i class="fas fa-times-circle"></i> Finish
                            Practice</button>
                    </div>
                </div>

                <!-- Shadowing Overlay -->
                <div v-if="currentMode === 'shadowing'" class="quiz-card shadowing-card">
                    <img :src="overlayWord.image" alt="Word Image" class="quiz-image">
                    <div class="shadowing-info-container">
                        <div class="shadowing-text">{{ overlayWord.chinese }}</div>
                        <div class="shadowing-text-pinyin">{{ overlayWord.pinyin }}</div>
                        <div class="shadowing-text-english">{{ overlayWord.english }}</div>
                    </div>
                    <div :class="['shadowing-status', shadowingStatusClass]">
                        <i :class="shadowingStatusIcon"></i> {{ shadowingStatusText }}
                    </div>
                    <div class="shadowing-controls">
                        <button v-show="shadowingState !== 'recording'" @click="handleShadowingMainAction"
                            :class="isLooping ? 'pause-btn' : 'replay-btn'">
                            <i :class="shadowingMainActionIcon"></i>
                            {{ shadowingMainActionText }}
                        </button>
                        <button v-if="shadowingState === 'recording'" @click="stopManualRecording" class="pause-btn"><i
                                class="fas fa-pause"></i> Pause Recording</button>
                        <button v-if="!autoRecord && shadowingState === 'idle'" @click="startManualRecording"
                            class="record-btn"><i class="fas fa-microphone"></i> Record</button>

                        <div class="nav-btn-group">
                            <button @click="playPrev" class="quiz-btn"><i class="fas fa-arrow-left"></i> Prev</button>
                            <button @click="playNext" class="quiz-btn"><i class="fas fa-arrow-right"></i> Next</button>
                        </div>
                        <button @click="stopPlayback" class="finish-quiz-btn"><i class="fas fa-times-circle"></i> Finish
                            Practice</button>
                    </div>
                </div>

                <!-- Multiple Choice (Quiz, Animal Match, Category Match) -->
                <div v-if="isQuizLikeMode" class="quiz-card">
                    <div class="quiz-header">
                        <div class="quiz-score-live">Score: <span class="score-correct">✅ {{ quizScore.correct }}</span>
                            / <span class="score-wrong">❌ {{ quizScore.wrong }}</span></div>
                    </div>

                    <div v-if="currentMode === 'animalMatch'" style="text-align: center; margin-bottom: 20px;">
                        <img :src="overlayWord.image" alt="Animal" class="quiz-image" style="height: 300px;">
                        <button @click="replayAudio" class="replay-btn" style="width: auto; padding: 10px 30px;"><i
                                class="fas fa-volume-up"></i> Listen</button>
                        <h3 style="font-size: 1.5em; color: #4a00e0;">How many animals are there?</h3>
                    </div>

                    <div v-else-if="currentMode === 'categoryMatch'" style="text-align: center; margin-bottom: 20px;">
                        <img :src="overlayWord.image" alt="Animal" class="quiz-image" style="height: 300px;">
                        <h3 style="font-size: 1.5em; color: #4a00e0;">Which category is this?</h3>
                    </div>

                    <div v-else>
                        <img :src="overlayWord.image" alt="Word Image" class="quiz-image">
                    </div>

                    <div class="quiz-options-large">
                        <button v-for="choice in quizChoices" :key="choice.id"
                            :class="['quiz-btn', getQuizBtnClass(choice)]" :disabled="quizAnswered"
                            @click="handleQuizAnswer(choice)">
                            {{ getChoiceLabel(choice) }}
                        </button>
                    </div>
                    <button @click="stopPlayback" class="finish-quiz-btn"><i class="fas fa-times-circle"></i> Finish
                        Quiz</button>
                </div>

                <!-- Writing Practice (Hanzi/Pinyin) -->
                <div v-if="currentMode === 'writingPinyin' || currentMode === 'writingHanzi'" class="quiz-card">
                    <img :src="overlayWord.image" alt="Word Image" class="quiz-image">
                    <div style="text-align: center; margin-bottom: 10px;">
                        <h3 v-if="currentMode === 'writingPinyin'" style="font-size: 2em; color: #333;">{{
                            overlayWord.chinese }}</h3>
                        <h3 v-else style="font-size: 1.2em; color: #666; font-style: italic;">{{ overlayWord.english }}
                        </h3>
                        <button @click="replayAudio" class="replay-btn"
                            style="width: auto; margin-top: 10px; padding: 8px 25px;"><i class="fas fa-volume-up"></i>
                            Listen</button>
                    </div>

                    <div class="writing-input-container">
                        <input type="text" v-model="userInput" @keyup.enter="checkWritingAnswer"
                            :class="['writing-input', writingStatus]"
                            :placeholder="currentMode === 'writingPinyin' ? 'Type Pinyin' : 'Type Hanzi'" autofocus>
                    </div>

                    <div v-if="quizAnswered" class="recall-info-container" style="min-height: 60px;">
                        <div class="recall-text"
                            :style="{ color: writingStatus === 'correct' ? '#28a745' : '#dc3545' }">
                            Correct: {{ currentMode === 'writingPinyin' ? overlayWord.pinyin : overlayWord.chinese }}
                        </div>
                    </div>

                    <div class="nav-btn-group">
                        <button @click="playPrev" class="quiz-btn"><i class="fas fa-arrow-left"></i> Prev</button>
                        <button @click="playNext" class="quiz-btn"><i class="fas fa-arrow-right"></i> Next</button>
                    </div>
                    <button @click="stopPlayback" class="finish-quiz-btn"><i class="fas fa-times-circle"></i> Finish
                        Practice</button>
                </div>

                <!-- Classifier Match -->
                <div v-if="currentMode === 'classifierMatch'" class="quiz-card">
                    <img :src="overlayWord.image" alt="Word Image" class="quiz-image">
                    <div style="text-align: center;">
                        <h3 style="font-size: 2em; color: #333;">{{ overlayWord.chinese }}</h3>
                        <p style="color: #666; margin-bottom: 15px;">{{ overlayWord.english }}</p>
                    </div>

                    <div class="classifier-bubble">
                        {{ quizAnswered ? (overlayWord.classifier || '无') : '?' }}
                    </div>

                    <div class="quiz-options-large" style="margin-top: 20px;">
                        <button v-for="choice in quizChoices" :key="choice"
                            :class="['quiz-btn', getClassifierBtnClass(choice)]" :disabled="quizAnswered"
                            @click="handleClassifierAnswer(choice)">
                            {{ choice }}
                        </button>
                    </div>
                    <button @click="stopPlayback" class="finish-quiz-btn"><i class="fas fa-times-circle"></i> Finish
                        Quiz</button>
                </div>

            </div>
        </main>
    </div>

    <script src="words_data.js"></script>
    <script src="script.js"></script>
</body>

</html>